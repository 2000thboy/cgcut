<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CLIP ç´ æå¤„ç†åå°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #111827; }
        .progress-bar { transition: width 0.3s ease; }
    </style>
</head>
<body class="min-h-screen text-gray-100">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- æ ‡é¢˜ -->
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-teal-400">ğŸ¬ CLIP ç´ æå¤„ç†åå°</h1>
            <p class="text-gray-400 mt-2">æ‰¹é‡å¤„ç†è§†é¢‘ç´ æï¼Œç”ŸæˆAIæ ‡ç­¾å’Œæè¿°</p>
        </div>

        <!-- æœåŠ¡çŠ¶æ€ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4">ğŸ“Š æœåŠ¡çŠ¶æ€</h2>
            <div class="grid grid-cols-4 gap-4">
                <div class="bg-gray-900 rounded p-4">
                    <div class="text-gray-400 text-sm">æ¨¡å‹</div>
                    <div class="text-lg font-bold text-teal-400" id="model-name">åŠ è½½ä¸­...</div>
                </div>
                <div class="bg-gray-900 rounded p-4">
                    <div class="text-gray-400 text-sm">è®¾å¤‡</div>
                    <div class="text-lg font-bold text-blue-400" id="device">-</div>
                </div>
                <div class="bg-gray-900 rounded p-4">
                    <div class="text-gray-400 text-sm">æ ‡ç­¾æ•°</div>
                    <div class="text-lg font-bold text-purple-400" id="tags-count">-</div>
                </div>
                <div class="bg-gray-900 rounded p-4">
                    <div class="text-gray-400 text-sm">çŠ¶æ€</div>
                    <div class="text-lg font-bold text-green-400" id="status">å°±ç»ª</div>
                </div>
            </div>
        </div>

        <!-- ç´ æåº“é…ç½® -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4">ğŸ“ ç´ æåº“é…ç½®</h2>
            <div class="flex gap-4 mb-4">
                <input type="text" id="library-path" value="U:\PreVis_Assets" 
                    class="flex-1 px-4 py-2 bg-gray-900 border border-gray-600 rounded text-gray-100"
                    placeholder="è¾“å…¥ç´ æåº“è·¯å¾„...">
                <button onclick="scanDirectory()" 
                    class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    ğŸ” æ‰«æç›®å½•
                </button>
            </div>
            <div id="scan-result" class="text-gray-400 text-sm"></div>
        </div>

        <!-- å¤„ç†æ§åˆ¶ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4">âš™ï¸ æ‰¹é‡å¤„ç†</h2>
            
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label class="text-gray-400 text-sm">å¤„ç†æ•°é‡é™åˆ¶ (0=å…¨éƒ¨)</label>
                    <input type="number" id="process-limit" value="0" min="0"
                        class="w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded text-gray-100 mt-1">
                </div>
                <div class="flex-1">
                    <label class="text-gray-400 text-sm">æ‰¹æ¬¡å¤§å°</label>
                    <input type="number" id="batch-size" value="10" min="1" max="50"
                        class="w-full px-4 py-2 bg-gray-900 border border-gray-600 rounded text-gray-100 mt-1">
                </div>
            </div>

            <div class="flex gap-4">
                <button onclick="startProcessing()" id="btn-start"
                    class="px-6 py-3 bg-teal-600 text-white rounded hover:bg-teal-700 font-semibold">
                    ğŸš€ å¼€å§‹å¤„ç†
                </button>
                <button onclick="stopProcessing()" id="btn-stop" disabled
                    class="px-6 py-3 bg-red-600 text-white rounded hover:bg-red-700 font-semibold disabled:bg-gray-600">
                    â¹ åœæ­¢
                </button>
                <button onclick="exportResults()"
                    class="px-6 py-3 bg-purple-600 text-white rounded hover:bg-purple-700 font-semibold">
                    ğŸ’¾ å¯¼å‡ºç»“æœ
                </button>
            </div>
        </div>

        <!-- è¿›åº¦æ˜¾ç¤º -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6 border border-gray-700" id="progress-section" style="display:none;">
            <h2 class="text-xl font-semibold mb-4">ğŸ“ˆ å¤„ç†è¿›åº¦</h2>
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-1">
                    <span id="progress-text">0 / 0</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-gray-700 rounded-full h-4">
                    <div id="progress-bar" class="progress-bar bg-teal-500 h-4 rounded-full" style="width: 0%"></div>
                </div>
            </div>
            <div class="text-sm text-gray-400">
                <span>é¢„è®¡å‰©ä½™æ—¶é—´: </span><span id="eta">è®¡ç®—ä¸­...</span>
            </div>
            <div class="mt-4 text-sm">
                <span class="text-green-400">âœ“ æˆåŠŸ: <span id="success-count">0</span></span>
                <span class="text-red-400 ml-4">âœ— å¤±è´¥: <span id="fail-count">0</span></span>
            </div>
        </div>

        <!-- å¤„ç†æ—¥å¿— -->
        <div class="bg-gray-800 rounded-lg p-6 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4">ğŸ“ å¤„ç†æ—¥å¿—</h2>
            <div id="log-container" class="bg-gray-900 rounded p-4 h-64 overflow-y-auto font-mono text-sm">
                <div class="text-gray-500">ç­‰å¾…å¼€å§‹...</div>
            </div>
        </div>
    </div>

    <script>
        let isProcessing = false;
        let processedFiles = [];
        let startTime = null;

        // åŠ è½½æœåŠ¡çŠ¶æ€
        async function loadStatus() {
            try {
                const res = await fetch('/clip');
                const data = await res.json();
                document.getElementById('model-name').textContent = data.model.split('/').pop();
                document.getElementById('device').textContent = data.device.toUpperCase();
                document.getElementById('tags-count').textContent = data.tags_count;
            } catch (e) {
                console.error('åŠ è½½çŠ¶æ€å¤±è´¥:', e);
            }
        }

        // æ‰«æç›®å½•
        async function scanDirectory() {
            const path = document.getElementById('library-path').value;
            if (!path) return alert('è¯·è¾“å…¥è·¯å¾„');

            document.getElementById('scan-result').textContent = 'æ‰«æä¸­...';
            
            try {
                const res = await fetch('/clip/list', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ directory: path, limit: 0, get_duration: false })
                });
                const data = await res.json();
                document.getElementById('scan-result').innerHTML = 
                    `<span class="text-green-400">âœ“ å‘ç° ${data.summary.totalFiles} ä¸ªè§†é¢‘æ–‡ä»¶</span>`;
                processedFiles = data.files;
            } catch (e) {
                document.getElementById('scan-result').innerHTML = 
                    `<span class="text-red-400">âœ— æ‰«æå¤±è´¥: ${e.message}</span>`;
            }
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const container = document.getElementById('log-container');
            const colors = { info: 'text-gray-300', success: 'text-green-400', error: 'text-red-400', warn: 'text-yellow-400' };
            const time = new Date().toLocaleTimeString();
            container.innerHTML += `<div class="${colors[type]}">[${time}] ${message}</div>`;
            container.scrollTop = container.scrollHeight;
        }

        // å¼€å§‹å¤„ç†
        async function startProcessing() {
            if (processedFiles.length === 0) {
                return alert('è¯·å…ˆæ‰«æç›®å½•');
            }

            isProcessing = true;
            startTime = Date.now();
            document.getElementById('btn-start').disabled = true;
            document.getElementById('btn-stop').disabled = false;
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('status').textContent = 'å¤„ç†ä¸­...';
            document.getElementById('status').className = 'text-lg font-bold text-yellow-400';
            document.getElementById('log-container').innerHTML = '';

            const limit = parseInt(document.getElementById('process-limit').value) || 0;
            const batchSize = parseInt(document.getElementById('batch-size').value) || 10;
            const filesToProcess = limit > 0 ? processedFiles.slice(0, limit) : processedFiles;
            const total = filesToProcess.length;

            addLog(`å¼€å§‹å¤„ç† ${total} ä¸ªæ–‡ä»¶ï¼Œæ‰¹æ¬¡å¤§å°: ${batchSize}`, 'info');

            let successCount = 0;
            let failCount = 0;
            const results = [];

            for (let i = 0; i < total && isProcessing; i++) {
                const file = filesToProcess[i];
                
                try {
                    const res = await fetch('/clip/process', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ file_path: file.filePath, extract_keyframes: true })
                    });
                    
                    if (res.ok) {
                        const data = await res.json();
                        results.push({ ...file, clipMetadata: data, status: 'success' });
                        successCount++;
                        addLog(`âœ“ ${file.label}`, 'success');
                    } else {
                        results.push({ ...file, status: 'error', error: res.statusText });
                        failCount++;
                        addLog(`âœ— ${file.label}: ${res.statusText}`, 'error');
                    }
                } catch (e) {
                    results.push({ ...file, status: 'error', error: e.message });
                    failCount++;
                    addLog(`âœ— ${file.label}: ${e.message}`, 'error');
                }

                // æ›´æ–°è¿›åº¦
                const progress = ((i + 1) / total * 100).toFixed(1);
                document.getElementById('progress-bar').style.width = progress + '%';
                document.getElementById('progress-text').textContent = `${i + 1} / ${total}`;
                document.getElementById('progress-percent').textContent = progress + '%';
                document.getElementById('success-count').textContent = successCount;
                document.getElementById('fail-count').textContent = failCount;

                // è®¡ç®—ETA
                const elapsed = (Date.now() - startTime) / 1000;
                const avgTime = elapsed / (i + 1);
                const remaining = avgTime * (total - i - 1);
                document.getElementById('eta').textContent = formatTime(remaining);
            }

            // å®Œæˆ
            isProcessing = false;
            document.getElementById('btn-start').disabled = false;
            document.getElementById('btn-stop').disabled = true;
            document.getElementById('status').textContent = 'å®Œæˆ';
            document.getElementById('status').className = 'text-lg font-bold text-green-400';

            addLog(`å¤„ç†å®Œæˆï¼æˆåŠŸ: ${successCount}, å¤±è´¥: ${failCount}`, 'info');

            // è‡ªåŠ¨ä¿å­˜ç»“æœ
            await saveResults(results);
        }

        // åœæ­¢å¤„ç†
        function stopProcessing() {
            isProcessing = false;
            addLog('ç”¨æˆ·åœæ­¢å¤„ç†', 'warn');
        }

        // ä¿å­˜ç»“æœåˆ°æœåŠ¡å™¨
        async function saveResults(results) {
            try {
                const res = await fetch('/clip/save-results', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ results })
                });
                if (res.ok) {
                    addLog('âœ“ ç»“æœå·²ä¿å­˜åˆ°æœåŠ¡å™¨', 'success');
                }
            } catch (e) {
                addLog('ä¿å­˜å¤±è´¥: ' + e.message, 'error');
            }
        }

        // å¯¼å‡ºç»“æœ
        function exportResults() {
            const data = JSON.stringify(processedFiles, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `clip_results_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // æ ¼å¼åŒ–æ—¶é—´
        function formatTime(seconds) {
            if (seconds < 60) return Math.round(seconds) + 'ç§’';
            if (seconds < 3600) return Math.round(seconds / 60) + 'åˆ†é’Ÿ';
            return Math.round(seconds / 3600) + 'å°æ—¶';
        }

        // åˆå§‹åŒ–
        loadStatus();
    </script>
</body>
</html>
